<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∏ –∏ –∑–∞—Ä–ø–ª–∞—Ç–∞ ‚Äî classic</title>
<meta name="theme-color" content="#0f1115">
<style>
/* ====== –ö–õ–ê–°–°–ò–ß–ï–°–ö–ò–ô –í–ò–î (–∫–∞–∫ —Ä–∞–Ω—å—à–µ) ====== */
:root{
  --bg:#0f1115;--card:#151922;--muted:#9aa3b2;--text:#eef2ff;--accent:#3b82f6;
  --pill:#222635;--pill-b:#2b3142;--ok:#1f9156;--danger:#b33;--warn:#b2891f;
  --day:#1a1f2b;--day-b:#21283a;--holiday:#5a1c24;--selected:#2051b8;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--text)}
h1{font-weight:800;margin:0}
h2{margin:0 0 8px}
a{color:inherit}
.container{max-width:880px;margin:0 auto;padding:12px}
.header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,var(--bg) 70%,#0000);padding:12px 0 6px}
.brand{display:flex;gap:12px;align-items:flex-end}
.brand-title{font-size:28px;line-height:1}
.brand-sub{font-size:16px;opacity:.8}
.tabs{display:flex;gap:10px;margin:14px 0 6px;flex-wrap:wrap}
.tab{border:1px solid var(--pill-b);background:var(--pill);color:var(--text);padding:10px 16px;border-radius:12px;cursor:pointer}
.tab.active{background:var(--accent);border-color:var(--accent)}
.card{background:var(--card);border:1px solid #1f2534;border-radius:16px;padding:14px;margin:12px 0}
.row{display:flex;gap:12px;flex-wrap:wrap}
label{display:block;font-size:14px;color:var(--muted);margin:6px 0}
input,select,button{font:inherit}
.input,select{width:100%;background:#0f1115;border:1px solid #2a3144;color:var(--text);padding:14px 12px;border-radius:12px;outline:none}
.select-wrap{position:relative}
.action{background:var(--accent);border:none;color:white;padding:14px 16px;border-radius:14px}
.pills-2x2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.pill{background:var(--pill);border:1px solid var(--pill-b);border-radius:14px;padding:16px;text-align:center}
.pill:active{transform:scale(.99)}
.small{font-size:13px;color:var(--muted)}
.center{display:flex;align-items:center;justify-content:center}
.sep{height:1px;background:#1f2534;margin:14px 0}
.grid-7{display:grid;grid-template-columns:repeat(7,1fr);gap:12px}
.day-hdr{color:var(--muted);text-align:center}
.day{background:var(--day);border:1px solid var(--day-b);border-radius:20px;height:54px;display:flex;align-items:center;justify-content:center;position:relative}
.day .mark{position:absolute;bottom:6px;font-size:12px;opacity:.85}
.day.holiday{background:var(--holiday);border-color:#7a2833}
.day.selected{outline:3px solid var(--selected)}
.cal-nav{display:flex;align-items:center;justify-content:space-between;margin:4px 0 10px}
.navbtn{background:var(--pill);border:1px solid var(--pill-b);border-radius:12px;padding:10px 14px}
.month-title{font-size:26px;font-weight:800}
.badge{display:inline-flex;gap:6px;align-items:center;background:#14311f;border:1px solid #1f4e2e;color:#bff1d2;border-radius:10px;padding:8px 10px}
.badge.warn{background:#30240f;border-color:#5c4a1a;color:#ffefb3}
.badge.danger{background:#3a1818;border-color:#6a2a2a;color:#ffc3c3}
.flex-between{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
footer{opacity:.6;margin:18px 0 10px}
.hidden{display:none}
/* fix –º–æ–±–∏–ª—å–Ω—ã—Ö –æ—Ç—Å—Ç—É–ø–æ–≤ –≤–æ–∫—Ä—É–≥ –ø–æ–ª—è ¬´–ß–∞—Å—ã¬ª */
#hours{margin-bottom:10px}
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="brand">
        <div>
          <div class="brand-title">–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∏</div>
          <div class="brand-sub">–∏ –∑–∞—Ä–ø–ª–∞—Ç–∞</div>
        </div>
        <div id="js-ok" class="badge" style="display:none">JS —Ä–∞–±–æ—Ç–∞–µ—Ç ‚úÖ</div>
      </div>
      <div class="tabs" id="tabs">
        <button class="tab active" data-tab="journal">–ñ—É—Ä–Ω–∞–ª</button>
        <button class="tab" data-tab="settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        <button class="tab" data-tab="holidays">–ü—Ä–∞–∑–¥–Ω–∏–∫–∏</button>
        <button class="tab" data-tab="import">–ò–º–ø–æ—Ä—Ç</button>
      </div>
    </div>

    <!-- ===== –ñ–£–†–ù–ê–õ ===== -->
    <section id="journal" class="card">
      <div class="row">
        <div style="flex:1 1 220px">
          <label>–î–∞—Ç–∞</label>
          <input id="date" type="date" class="input">
        </div>
        <div style="flex:1 1 220px">
          <label>–¢–∏–ø</label>
          <select id="type" class="input">
            <option value="work" selected>–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∞</option>
            <option value="leave">–û—Ç–≥—É–ª</option>
            <option value="vacation">–û—Ç–ø—É—Å–∫</option>
          </select>
        </div>
      </div>
      <div>
        <label>–ß–∞—Å—ã</label>
        <input id="hours" class="input" inputmode="decimal" placeholder="–Ω–∞–ø—Ä., 3.5">
      </div>
      <div class="row">
        <button id="addBtn" class="action">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>

      <div class="sep"></div>
      <div>
        <div class="small" style="margin-bottom:8px">–ë—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ (–ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ ¬´–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∞¬ª):</div>
        <div class="pills-2x2" id="quick">
          <button class="pill" data-quick="hrs-3.5">3.5 —á</button>
          <button class="pill" data-quick="hrs-8">8 —á</button>
          <button class="pill" data-quick="leave">–û—Ç–≥—É–ª</button>
          <button class="pill" data-quick="vacation">–û—Ç–ø—É—Å–∫</button>
        </div>
      </div>

      <div class="sep"></div>
      <div class="card" style="margin:-2px 0 10px">
        <div class="cal-nav">
          <button class="navbtn" id="prevM">‚óÄ –ü—Ä–µ–¥—ã–¥—É—â–∏–π</button>
          <div class="month-title" id="monthTitle">‚Äî</div>
          <button class="navbtn" id="nextM">–°–ª–µ–¥—É—é—â–∏–π ‚ñ∂</button>
        </div>
        <div class="grid-7" id="dow"></div>
        <div class="grid-7" id="days"></div>
        <div class="small" style="margin-top:10px">
          üî® ‚Äî –µ—Å—Ç—å –ø–æ–¥—Ä–∞–±–æ—Ç–∫–∞; üèñ ‚Äî –æ—Ç–ø—É—Å–∫; –±–æ—Ä–¥–æ–≤—ã–π —Ñ–æ–Ω ‚Äî –ø—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–π –¥–µ–Ω—å.
        </div>
      </div>

      <div class="flex-between">
        <div>
          <div class="small">–û–∫–ª–∞–¥ –∑–∞ –æ—Ç—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –¥–Ω–∏:</div>
          <div id="baseSum" style="font-size:20px;font-weight:700">‚Äî</div>
          <div id="hourRate" class="small">‚Äî ‚ÇΩ/—á</div>
        </div>
        <div>
          <div class="small">–ü–æ–¥—Ä–∞–±–æ—Ç–∫–∏:</div>
          <div id="otSum" style="font-size:20px;font-weight:700">‚Äî</div>
          <div id="otHours" class="small">–ß–∞—Å—ã –ø–æ–¥—Ä–∞–±–æ—Ç–æ–∫: ‚Äî —á</div>
        </div>
        <div>
          <div class="small">–û—Ç–ø—É—Å–∫:</div>
          <div id="leaveSum" style="font-size:20px;font-weight:700">‚Äî</div>
          <div id="leaveInfo" class="small"></div>
        </div>
      </div>
      <div class="sep"></div>
      <div style="font-size:28px;font-weight:800">–ò—Ç–æ–≥–æ –∫ –≤—ã–ø–ª–∞—Ç–µ: <span id="total">‚Äî</span></div>
    </section>

    <!-- ===== –ù–ê–°–¢–†–û–ô–ö–ò ===== -->
    <section id="settings" class="card hidden">
      <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞—Å—á—ë—Ç–∞</h2>
      <div class="row">
        <div style="flex:1 1 280px">
          <label>–¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü</label>
          <input id="monthPicker" class="input" type="month">
        </div>
        <div style="flex:1 1 200px">
          <label>–û–∫–ª–∞–¥ (–Ω–∞ —Ä—É–∫–∏), ‚ÇΩ</label>
          <input id="salary" class="input" type="number" min="0" step="1" placeholder="0">
        </div>
        <div style="flex:1 1 160px">
          <label>–ß–∞—Å–æ–≤ –≤ –¥–Ω–µ</label>
          <input id="hpd" class="input" type="number" min="1" step="1" value="8">
        </div>
      </div>
      <div class="row">
        <div style="flex:1 1 240px">
          <label>–¢–∏–ø –æ—Ç–ø—É—Å–∫–∞</label>
          <select id="vacType" class="input">
            <option value="calendar">–ö–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–π (–≤—Å–µ –¥–Ω–∏)</option>
            <option value="production">–ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–π (—Ç–æ–ª—å–∫–æ –±—É–¥–Ω–∏)</option>
          </select>
        </div>
        <div style="flex:1 1 240px">
          <label>–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ / –∫—ç—à</label><br>
          <button id="refresh" class="navbtn">–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</button>
          <button id="disableSw" class="navbtn">–û—Ç–∫–ª—é—á–∏—Ç—å –æ—Ñ—Ñ–ª–∞–π–Ω-–∫—ç—à</button>
        </div>
      </div>
      <div class="sep"></div>
      <div class="flex-between">
        <button id="clear" class="navbtn" style="border-color:#5b2a2a;background:#351a1a;color:#ffcdcd">–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ</button>
        <div class="small">–í–µ—Ä—Å–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞: <b>classic</b></div>
      </div>
    </section>

    <!-- ===== –ü–†–ê–ó–î–ù–ò–ö–ò ===== -->
    <section id="holidays" class="card hidden">
      <h2>–ü—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–µ –¥–Ω–∏ –º–µ—Å—è—Ü–∞</h2>
      <div class="small" id="hinfo">–¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü: ‚Äî</div>
      <div class="sep"></div>
      <div class="grid-7" id="hdow"></div>
      <div class="grid-7" id="hdays"></div>
    </section>

    <!-- ===== –ò–ú–ü–û–†–¢ / –≠–ö–°–ü–û–†–¢ ===== -->
    <section id="import" class="card hidden">
      <h2>–ò–º–ø–æ—Ä—Ç / –≠–∫—Å–ø–æ—Ä—Ç</h2>
      <div class="row">
        <button id="export" class="navbtn">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
        <input id="importFile" type="file" accept="application/json">
      </div>
      <div class="sep"></div>
      <div class="small">–§–∞–π–ª —Å–æ–≤–º–µ—Å—Ç–∏–º —Å–æ —Å—Ç–∞—Ä—ã–º–∏ –≤–µ—Ä—Å–∏—è–º–∏; –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–∏–≤–æ–¥–∏—Ç—Å—è –∫ –Ω–æ–≤–æ–π.</div>
    </section>

    <footer class="small">¬© –ü–æ–¥—Ä–∞–±–æ—Ç–∫–∏ ‚Äî –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å</footer>
  </div>

<script>
(() => {
  const $ = sel => document.querySelector(sel);
  const $$ = (sel,root=document) => Array.from(root.querySelectorAll(sel));
  const fmtMoney = n => n.toLocaleString('ru-RU')+' ‚ÇΩ';
  const pad = n => String(n).padStart(2,'0');

  const today = new Date();
  let state = load() || initState();

  // === –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI ===
  $('#js-ok').style.display='inline-flex';
  initTabs();
  $('#monthPicker').value = state.month;
  $('#salary').value = state.salary;
  $('#hpd').value = state.hpd;
  $('#vacType').value = state.vacType;

  // –¥–∞—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî —Å–µ–≥–æ–¥–Ω—è
  $('#date').value = `${state.y}-${pad(state.m+1)}-${pad(today.getDate())}`;
  drawJournalCalendar();
  drawHolidaysCalendar();
  recalc();

  // --- –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ ---
  $('#addBtn').onclick = () => {
    const d = $('#date').value;
    const t = $('#type').value;
    const raw = $('#hours').value.trim();
    let h = raw? parseFloat(raw.replace(',','.')) : 0;
    if (!d) return alert('–í—ã–±–µ—Ä–∏ –¥–∞—Ç—É.');
    if (t==='work' && !h) return alert('–£–∫–∞–∂–∏ —á–∞—Å—ã.');
    addEntry(d,t,h);
    $('#hours').value='';
  };

  // –±—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏
  $('#quick').addEventListener('click', e=>{
    const q = e.target.closest('.pill')?.dataset.quick;
    if(!q) return;
    const d = $('#date').value;
    if(!d) return alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –¥–∞—Ç—É.');
    if(q==='hrs-3.5'){ addEntry(d,'work',3.5); }
    else if(q==='hrs-8'){ addEntry(d,'work',8); }
    else if(q==='leave'){ // –æ—Ç–≥—É–ª ‚Äî —Å–ø—Ä–æ—Å–∏–º —á–∞—Å—ã
      const v = prompt('–°–∫–æ–ª—å–∫–æ —á–∞—Å–æ–≤ –≤—ã—á–µ—Å—Ç—å (–æ—Ç–≥—É–ª)?','2');
      const h = v? parseFloat(String(v).replace(',','.')):0;
      if(h>0) addEntry(d,'leave',h);
    } else if(q==='vacation'){ // –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –æ—Ç–ø—É—Å–∫–Ω–æ–π –¥–µ–Ω—å
      toggleVacationDay(d);
    }
  });

  // —Å–∫—Ä—ã–≤–∞—Ç—å –±—ã—Å—Ç—Ä—ã–µ –ø—Ä–∏ —Å–º–µ–Ω–µ —Ç–∏–ø–∞
  $('#type').addEventListener('change', ()=>{
    $('#quick').style.display = ($('#type').value==='work')?'grid':'none';
  });

  // –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è
  $('#prevM').onclick = ()=>changeMonth(-1);
  $('#nextM').onclick = ()=>changeMonth(+1);

  // –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
  $('#monthPicker').onchange = e=>{
    const [yy,mm] = e.target.value.split('-').map(Number);
    state.y = yy; state.m = mm-1; state.month = e.target.value;
    save(); drawJournalCalendar(); drawHolidaysCalendar(); recalc();
  };
  $('#salary').oninput = e=>{ state.salary = +e.target.value||0; save(); recalc(); };
  $('#hpd').oninput = e=>{ state.hpd = +e.target.value||8; save(); recalc(); };
  $('#vacType').onchange = e=>{ state.vacType = e.target.value; save(); recalc(); };

  $('#export').onclick = exportJSON;
  $('#importFile').onchange = importJSON;
  $('#clear').onclick = ()=>{
    if(confirm('–¢–æ—á–Ω–æ —Å—Ç–µ—Ä–µ—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ?')){
      localStorage.removeItem('paycalc_state');
      state = initState(); save();
      location.reload();
    }
  };
  $('#refresh').onclick = refreshApp;
  $('#disableSw').onclick = disableSW;

  // ========= –§–£–ù–ö–¶–ò–ò –°–û–°–¢–û–Ø–ù–ò–Ø =========
  function initState(){
    const d = new Date();
    const month = `${d.getFullYear()}-${pad(d.getMonth()+1)}`;
    return { y:d.getFullYear(), m:d.getMonth(), month, salary:0, hpd:8, vacType:'production',
             entries:[], holidays:{} };
  }
  function load(){
    try{
      const s = JSON.parse(localStorage.getItem('paycalc_state')||'null');
      if(!s) return null;
      // –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ä—ã—Ö –¥–∞–º–ø–æ–≤
      s.entries = Array.isArray(s.entries)? s.entries : [];
      s.holidays = s.holidays && typeof s.holidays==='object'? s.holidays : {};
      s.salary = Number(s.salary||0);
      s.hpd = Number(s.hpd||8);
      s.vacType = s.vacType||'production';
      if(typeof s.y!=='number' || typeof s.m!=='number'){
        const d = new Date();
        s.y=d.getFullYear(); s.m=d.getMonth();
      }
      s.month = s.month || `${s.y}-${pad(s.m+1)}`;
      return s;
    }catch(e){ return null; }
  }
  function save(){ localStorage.setItem('paycalc_state', JSON.stringify(state)); }

  function changeMonth(delta){
    const d = new Date(state.y, state.m + delta, 1);
    state.y = d.getFullYear(); state.m = d.getMonth();
    state.month = `${state.y}-${pad(state.m+1)}`;
    $('#monthPicker').value = state.month;
    save(); drawJournalCalendar(); drawHolidaysCalendar(); recalc();
  }

  function addEntry(iso, type, hours){
    // –µ—Å–ª–∏ –æ—Ç–ø—É—Å–∫: –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –¥–µ–Ω—å-—Ñ–ª–∞–≥
    if(type==='vacation'){ toggleVacationDay(iso); return; }
    state.entries.push({date:iso,type,hrs:hours||0});
    save(); drawJournalCalendar(); recalc();
  }
  function toggleVacationDay(iso){
    const set = state.entries.filter(e=>e.date===iso && e.type==='vacation');
    if(set.length){ // —Å–Ω—è—Ç—å –æ—Ç–ø—É—Å–∫
      state.entries = state.entries.filter(e=>!(e.date===iso && e.type==='vacation'));
    }else{
      state.entries.push({date:iso,type:'vacation',hrs:0});
    }
    save(); drawJournalCalendar(); drawHolidaysCalendar(); recalc();
  }

  // ========= –ö–ê–õ–ï–ù–î–ê–†–ò =========
  const DOW = ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'];
  function drawDOW(node){ node.innerHTML = DOW.map(d=>`<div class="day-hdr">${d}</div>`).join(''); }

  function drawJournalCalendar(){
    $('#monthTitle').textContent = monthName(state.m)+' '+state.y+' –≥.';
    drawDOW($('#dow'));
    const box = $('#days'); box.innerHTML='';
    const first = new Date(state.y, state.m, 1);
    const last = new Date(state.y, state.m+1, 0);
    // –ø—É—Å—Ç—ã–µ –¥–æ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞
    let wd = (first.getDay()+6)%7;
    for(let i=0;i<wd;i++) box.appendChild(emptyDay());
    for(let d=1; d<=last.getDate(); d++){
      const iso = `${state.y}-${pad(state.m+1)}-${pad(d)}`;
      const cell = dayCell(d, iso, true);
      box.appendChild(cell);
    }
  }
  function drawHolidaysCalendar(){
    $('#hinfo').textContent = `–¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü: ${state.month}`;
    drawDOW($('#hdow'));
    const box = $('#hdays'); box.innerHTML='';
    const first = new Date(state.y, state.m, 1);
    const last = new Date(state.y, state.m+1, 0);
    let wd = (first.getDay()+6)%7;
    for(let i=0;i<wd;i++) box.appendChild(emptyDay());
    for(let d=1; d<=last.getDate(); d++){
      const iso = `${state.y}-${pad(state.m+1)}-${pad(d)}`;
      const el = dayCell(d, iso, false);
      el.onclick = ()=>{
        state.holidays[iso] = !state.holidays[iso];
        save(); drawHolidaysCalendar(); drawJournalCalendar(); recalc();
      };
      if(state.holidays[iso]) el.classList.add('holiday');
      box.appendChild(el);
    }
  }
  function emptyDay(){ const el=document.createElement('div'); el.className='day'; el.style.visibility='hidden'; return el; }
  function dayCell(num, iso, selectable){
    const el = document.createElement('div');
    el.className = 'day';
    const isHol = !!state.holidays[iso];
    if(isHol) el.classList.add('holiday');
    // –º–µ—Ç–∫–∏
    const marks = [];
    if(state.entries.some(e=>e.date===iso && e.type==='work')) marks.push('üî®');
    if(state.entries.some(e=>e.date===iso && e.type==='vacation')) marks.push('üèñ');
    el.innerHTML = `<div>${num}</div><div class="mark">${marks.join(' ')}</div>`;
    if(selectable){
      el.onclick = ()=>{
        $('#date').value = iso;
        $$('#days .day').forEach(x=>x.classList.remove('selected'));
        el.classList.add('selected');
      };
    }
    return el;
  }
  function monthName(m){
    return ['—è–Ω–≤–∞—Ä—å','—Ñ–µ–≤—Ä–∞–ª—å','–º–∞—Ä—Ç','–∞–ø—Ä–µ–ª—å','–º–∞–π','–∏—é–Ω—å','–∏—é–ª—å','–∞–≤–≥—É—Å—Ç','—Å–µ–Ω—Ç—è–±—Ä—å','–æ–∫—Ç—è–±—Ä—å','–Ω–æ—è–±—Ä—å','–¥–µ–∫–∞–±—Ä—å'][m];
  }

  // ========= –†–ê–°–ß–Å–¢–´ =========
  function isWeekend(dateObj){ const d=dateObj.getDay(); return d===0||d===6; } // –≤—Å=0 —Å–±=6
  function isWeekday(dateObj){ return !isWeekend(dateObj); }

  function workdaysInMonth(){
    const first = new Date(state.y, state.m, 1);
    const last = new Date(state.y, state.m+1, 0);
    let cnt=0;
    for(let d=1; d<=last.getDate(); d++){
      const obj = new Date(state.y, state.m, d);
      const iso = `${state.y}-${pad(state.m+1)}-${pad(d)}`;
      if(isWeekday(obj) && !state.holidays[iso]) cnt++;
    }
    return cnt;
  }

  function recalc(){
    const workDays = workdaysInMonth();
    const hpd = state.hpd||8;
    const baseHours = workDays * hpd;
    const hourRate = baseHours? (state.salary||0)/baseHours : 0;

    // –ü–æ–¥—Ä–∞–±–æ—Ç–∫–∏: –±—É–¥–Ω–∏/—Å–±/–≤—Å/–ø—Ä–∞–∑–¥–Ω–∏–∫–∏ ‚Äî —Å—á–∏—Ç–∞–µ–º –ø—Ä–æ—Å—Ç–æ –∫–∞–∫ —á–∞—Å—ã*—Å—Ç–∞–≤–∫–∞*–º–Ω–æ–∂–∏—Ç–µ–ª—å (–º–Ω–æ–∂–∏—Ç–µ–ª–∏ –º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å)
    let otHours=0, otSum=0;
    state.entries.forEach(e=>{
      if(e.type!=='work') return;
      const dt = new Date(e.date);
      const iso = e.date;
      const mul = state.holidays[iso] ? 2 : isWeekend(dt)? (dt.getDay()===6?1.5:2) : (e.hrs<=2?1.5:2);
      otHours += e.hrs;
      otSum += e.hrs * hourRate * mul;
    });

    // –û—Ç–≥—É–ª—ã ‚Äî –ø—Ä–æ—Å—Ç–æ –≤—ã—á–∏—Ç–∞–µ–º —á–∞—Å—ã –∏–∑ –±–∞–∑—ã
    let leaveHours=0;
    state.entries.forEach(e=>{ if(e.type==='leave') leaveHours += e.hrs; });
    const basePaidHours = Math.max(baseHours - leaveHours, 0);
    const baseSum = basePaidHours * hourRate;

    // –û—Ç–ø—É—Å–∫
    const vacDays = state.entries.filter(e=>e.type==='vacation').map(e=>e.date);
    let vacPaidDays = 0;
    if(state.vacType==='calendar'){
      vacPaidDays = vacDays.length;
    }else{
      vacPaidDays = vacDays.filter(iso=>{
        const d=new Date(iso);
        return isWeekday(d);
      }).length;
    }
    // —Å—Ä–µ–¥–Ω–µ–¥–Ω–µ–≤–Ω–æ–π –∑–∞ 12 –º–µ—Å: –±–µ—Ä—ë–º –æ–∫–ª–∞–¥*12 + –ø–æ–¥—Ä–∞–±–æ—Ç–∫–∏ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 12 –º–µ—Å (–≥—Ä—É–±–æ) / (29.3*12)
    const avgDaily = ((state.salary||0)*12) / (29.3*12);
    const vacSum = avgDaily * vacPaidDays;

    const total = Math.round(baseSum+otSum+vacSum);

    // –≤—ã–≤–æ–¥
    $('#hourRate').textContent = hourRate? `${Math.round(hourRate)} ‚ÇΩ/—á`:'‚Äî ‚ÇΩ/—á';
    $('#otHours').textContent = `–ß–∞—Å—ã –ø–æ–¥—Ä–∞–±–æ—Ç–æ–∫: ${otHours.toFixed(2)} —á`;
    $('#baseSum').textContent = baseHours? fmtMoney(Math.round(baseSum)) : '‚Äî';
    $('#otSum').textContent = otHours? fmtMoney(Math.round(otSum)) : '‚Äî';
    $('#leaveSum').textContent = vacPaidDays? fmtMoney(Math.round(vacSum)) : '‚Äî';
    $('#leaveInfo').textContent = vacPaidDays? `${vacPaidDays} –¥–Ω ¬∑ —Å—Ä.–¥–Ω–µ–≤–Ω.: ${Math.round(avgDaily).toLocaleString('ru-RU')}`:'';
    $('#total').textContent = total? fmtMoney(total) : '‚Äî';
  }

  // ========= –¢–ê–ë–´ =========
  function initTabs(){
    $('#tabs').addEventListener('click', e=>{
      const t = e.target.closest('.tab'); if(!t) return;
      const id = t.dataset.tab;
      $$('.tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      ['journal','settings','holidays','import'].forEach(x=>$('#'+x).classList.add('hidden'));
      $('#'+id).classList.remove('hidden');
      if(id==='holidays') drawHolidaysCalendar();
      if(id==='journal') drawJournalCalendar();
    });
  }

  // ========= –ò–ú–ü–û–†–¢/–≠–ö–°–ü–û–†–¢ =========
  function exportJSON(){
    const blob = new Blob([JSON.stringify(state)],{type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'paycalc_data.json';
    a.click();
  }
  function importJSON(ev){
    const f = ev.target.files?.[0]; if(!f) return;
    const r = new FileReader();
    r.onload = () => {
      try{
        const s = JSON.parse(String(r.result));
        // –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ä—ã—Ö –¥–∞–º–ø–æ–≤
        state.entries = Array.isArray(s.entries)? s.entries.map(x=>({
          date:x.date || x.d || x.iso,
          type:x.type || x.t || 'work',
          hrs: Number(x.hrs ?? x.h ?? 0)
        })) : [];
        state.holidays = s.holidays && typeof s.holidays==='object'? s.holidays : {};
        state.salary   = Number(s.salary ?? s.oklad ?? 0);
        state.hpd      = Number(s.hpd ?? s.hoursPerDay ?? 8);
        state.vacType  = s.vacType || s.vacationType || 'production';
        const now = new Date(); state.y = now.getFullYear(); state.m = now.getMonth();
        state.month = `${state.y}-${('0'+(state.m+1)).slice(-2)}`;
        save(); drawJournalCalendar(); drawHolidaysCalendar(); recalc();
        alert('–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω');
      }catch(e){ alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: '+e); }
      ev.target.value='';
    };
    r.readAsText(f);
  }

  // ========= –û–ë–ù–û–í–õ–ï–ù–ò–ï / SW =========
  async function refreshApp(){
    try{
      if('caches' in window){
        const keys = await caches.keys();
        await Promise.all(keys.map(k=>caches.delete(k)));
      }
    }catch{}
    location.replace(location.pathname+'?v='+(Date.now()));
  }
  async function disableSW(){
    try{
      const regs = await navigator.serviceWorker?.getRegistrations?.();
      if(regs?.length){ for(const r of regs) await r.unregister(); alert('–û—Ñ—Ñ–ª–∞–π–Ω-–∫—ç—à –æ—Ç–∫–ª—é—á—ë–Ω. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞‚Ä¶'); location.reload(); }
      else alert('Service Worker –Ω–µ –Ω–∞–π–¥–µ–Ω');
    }catch(e){ alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫–ª—é—á–∏—Ç—å SW: '+e); }
  }
})();
</script>
</body>
</html>
