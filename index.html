<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Подработки и зарплата</title>
<meta name="theme-color" content="#0b0d12">
<meta name="apple-mobile-web-app-capable" content="yes">
<style>
  *,*::before,*::after{box-sizing:border-box}
  :root{
    --bg:#0f1115;--card:#151922;--cardSoft:#1a1f1f;--text:#e9eef5;--muted:#9aa5b1;--line:#242a34;
    --accent:#3b82f6;--danger:#ef4444;--btn:#0f1320;--btnText:#e9eef5;
  }
  :root[data-theme="light"]{
    --bg:#f5f7fb;--card:#ffffff;--cardSoft:#f1f3f5;--text:#111827;--muted:#6b7280;--line:#e5e7eb;
    --accent:#2563eb;--danger:#b91c1c;--btn:#ffffff;--btnText:#111827;
  }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px;background:#0b0d12;border-bottom:1px solid var(--line);position:sticky;top:0;z-index:5;color:#fff}
  header h1{font-size:18px;margin:0;color:#fff}
  .tabs{display:flex;gap:8px;overflow:auto;padding-bottom:4px}
  .tab{padding:10px 12px;border:1px solid rgba(255,255,255,.25);border-radius:12px;background:transparent;color:#fff;cursor:pointer;flex:0 0 auto}
  .tab.active{background:rgba(255,255,255,.18);border-color:transparent}
  main{max-width:1050px;margin:0 auto;padding:12px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;margin:12px 0;overflow:hidden}
  label{display:block;color:var(--muted);font-size:12px;margin:6px 0}
  input,select,button{font:inherit}
  input,select{width:100%;padding:14px;border:1px solid var(--line);border-radius:12px;background:var(--btn);color:var(--btnText);min-height:44px}
  .row{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
  .col-3{grid-column:span 3}.col-4{grid-column:span 4}.col-5{grid-column:span 5}.col-6{grid-column:span 6}.col-12{grid-column:span 12}
  @media (max-width:860px){.col-3,.col-4,.col-5,.col-6{grid-column:span 12}}
  .btn{padding:14px 16px;border-radius:12px;border:1px solid var(--line);background:var(--btn);color:var(--btnText);cursor:pointer;min-height:44px}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:white}
  .btn.danger{background:#2b0f12;border-color:#4a171b;color:#ffd7db}
  .btn.small{padding:10px 12px;min-height:38px}
  .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .right{text-align:right}
  .muted{color:var(--muted);font-size:12px}
  .total{font-size:22px;font-weight:700}
  .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:10px}
  .day-head{color:var(--muted);text-align:center;font-size:12px}
  .day{position:relative;height:84px;background:var(--cardSoft);border:1px solid var(--line);border-radius:16px;cursor:pointer;transition:transform .05s ease;background-clip:padding-box}
  .day.has{border-color:var(--accent);background:rgba(59,130,246,.08)}
  .day.today{outline:2px solid var(--accent)}
  .day.selected{box-shadow:0 0 0 2px var(--accent) inset}
  .day .num{position:absolute;top:8px;left:0;right:0;text-align:center;font-weight:700}
  .day .badge{position:absolute;left:50%;transform:translateX(-50%);bottom:10px;text-align:center;border:1px solid var(--line);background:var(--card);width:28px;height:28px;line-height:26px;border-radius:999px;font-size:14px}
  .table-wrap{overflow:auto;border:1px solid var(--line);border-radius:12px;margin-top:8px}
  table{width:100%;border-collapse:collapse;min-width:560px}
  th,td{padding:12px;border-bottom:1px solid var(--line);text-align:left}
  thead th{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.04em}
  .quick-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;align-items:stretch;justify-items:stretch;max-width:520px;margin:0 auto}
  .quick-btn{display:flex;align-items:center;justify-content:center;min-height:56px;border-radius:12px;border:1px solid var(--line);background:var(--btn);color:var(--btnText);font-weight:600;cursor:pointer}
  .quick-btn:active{transform:scale(.98)}
  #banner{position:fixed;left:8px;right:8px;bottom:8px;background:#1f2937;color:#fff;border:1px solid #374151;border-radius:10px;padding:10px 12px;z-index:9999;display:none;white-space:pre-wrap}
  .version-note{margin-top:16px;color:var(--muted);font-size:12px;text-align:right}
  .tag{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid var(--line);border-radius:999px;font-size:12px;background:var(--cardSoft)}
</style>
</head>
<body>
<header>
  <h1>Подработки и зарплата</h1>
  <div class="tabs">
    <button class="tab active" data-tab="journal" type="button">Журнал</button>
    <button class="tab" data-tab="settings" type="button">Настройки</button>
    <button class="tab" data-tab="holidays" type="button">Праздники</button>
    <button class="tab" data-tab="backup" type="button">Импорт</button>
  </div>
</header>

<main>
  <!-- ЖУРНАЛ -->
  <section class="card" data-pane="journal">
    <div class="row">
      <div class="col-3">
        <label>Дата</label>
        <div class="toolbar" style="gap:8px">
          <input type="date" id="shiftDate" style="flex:1;min-width:0">
          <button class="btn small" id="todayBtn" type="button">Сегодня</button>
        </div>
      </div>
      <div class="col-3">
        <label>Тип</label>
        <select id="modeSelect">
          <option value="overtime">Подработка</option>
          <option value="leave">Отгул (за свой счёт)</option>
        </select>
      </div>
      <div class="col-3">
        <label>Часы</label>
        <input type="number" id="shiftHours" min="0.25" step="0.25" placeholder="напр., 3.5">
      </div>
      <div class="col-3">
        <!-- Категория убрана по запросу -->
        <label style="visibility:hidden">Категория (авто)</label>
        <div style="height:44px"></div>
      </div>
    </div>

    <div class="toolbar" style="margin-top:10px">
      <button class="btn primary" id="addShift" type="button">Добавить</button>
      <div class="muted" id="dayInfo"></div>
    </div>

    <div class="card" id="quickCard" style="margin-top:8px">
      <div class="muted" style="margin-bottom:8px">Быстрые кнопки (только для «Подработка»):</div>
      <div class="quick-grid">
        <button class="quick-btn" data-quick="hrs-3.5" type="button">3.5 ч</button>
        <button class="quick-btn" data-quick="hrs-8"   type="button">8 ч</button>
        <button class="quick-btn" data-quick="off"     type="button">Отгул</button>
        <button class="quick-btn" data-quick="vac"     type="button">Отпуск</button>
      </div>
    </div>

    <div class="card" id="calendarCard">
      <div class="total" id="monthTitle" style="text-align:center;margin-bottom:8px">—</div>
      <div class="toolbar" style="justify-content:space-between;margin-bottom:10px">
        <button class="btn small" id="prevMonth" type="button">◀︎ Предыдущий</button>
        <button class="btn small" id="nextMonth" type="button">Следующий ▶︎</button>
      </div>
      <div class="calendar" id="calendarGrid"></div>
      <div class="table-wrap" id="dayDetailWrap" style="display:none">
        <table>
          <thead><tr><th>Тип</th><th class="right">Часы/дни</th><th class="right">Сумма</th><th class="right">Действия</th></tr></thead>
          <tbody id="dayRows"></tbody>
        </table>
      </div>
    </div>

    <!-- Итоги -->
    <div class="row">
      <div class="col-4">
        <div>Оклад за отработанные дни: <span id="baseMonthlyOut">—</span></div>
        <div class="muted">Почасовая ставка (оклад): <span id="baseHourlyOut">—</span> ₽/ч</div>
      </div>
      <div class="col-4">
        <div>Подработки: <span id="overtimeOut">—</span></div>
        <div class="muted">Часы подработок: <span id="otHoursOut">—</span> ч</div>
      </div>
      <div class="col-4">
        <div>Итого к выплате:</div>
        <div class="total" id="grandTotal">—</div>
        <div class="muted" id="vacInfo"></div>
      </div>
    </div>
  </section>

  <!-- НАСТРОЙКИ -->
  <section class="card" data-pane="settings" style="display:none">
    <h3>Настройки расчёта</h3>
    <div class="row">
      <div class="col-3">
        <label>Текущий месяц</label>
        <input type="month" id="monthFilter">
      </div>
      <div class="col-3">
        <label>Оклад (на руки), ₽</label>
        <input type="number" id="baseMonthly" min="0" step="1" placeholder="введите сумму">
      </div>
      <div class="col-3">
        <label>Рабочих дней (авто, Пн–Пт)</label>
        <input id="autoWorkdays" disabled>
      </div>
      <div class="col-3">
        <label>Часов в дне</label>
        <input type="number" id="hoursPerDay" min="1" step="0.25" value="8">
      </div>
    </div>

    <div class="row">
      <div class="col-3"><label>Будни — первые 2 ч</label><input type="number" id="weekdayFirstMult" step="0.1" min="1" value="1.5"></div>
      <div class="col-3"><label>Будни — дальше</label><input type="number" id="weekdayNextMult" step="0.1" min="1" value="2"></div>
      <div class="col-3"><label>Суббота</label><input type="number" id="satMult" step="0.1" min="1" value="1.5"></div>
      <div class="col-3"><label>Воскресенье</label><input type="number" id="sunMult" step="0.1" min="1" value="2"></div>
    </div>

    <div class="row">
      <div class="col-3"><label>Праздник</label><input type="number" id="holidayMult" step="0.1" min="1" value="2"></div>
      <div class="col-5">
        <label>Оплата отпуска</label>
        <div><label><input type="radio" name="vacPayMode" value="calendar"> Календарный отпуск (все дни)</label></div>
        <div><label><input type="radio" name="vacPayMode" value="workdays"> Производственный отпуск (только будни)</label></div>
      </div>
      <div class="col-4">
        <label>Тема</label>
        <select id="themeSelect"><option value="dark">Тёмная</option><option value="light">Светлая</option></select>
      </div>
    </div>

    <div class="row">
      <div class="col-12">
        <label>Обновление приложения</label>
        <div class="toolbar">
          <button class="btn" id="updateAppBtn" type="button">Обновить приложение</button>
          <div class="muted" id="updateStatus"></div>
        </div>
      </div>
    </div>
    <div class="version-note">Версия приложения: <span id="appVersion">v6.6</span></div>
  </section>

  <!-- ПРАЗДНИКИ -->
  <section class="card" data-pane="holidays" style="display:none">
    <h3>Праздничные дни месяца</h3>
    <div class="muted">Текущий месяц: <b id="monthLabel"></b>. Нажмите на день, чтобы отметить/снять праздник.</div>
    <div id="holidayGrid" style="margin-top:10px"></div>
  </section>

  <!-- ИМПОРТ -->
  <section class="card" data-pane="backup" style="display:none">
    <h3>Импорт / Экспорт</h3>
    <div class="toolbar">
      <button class="btn" id="exportJSON" type="button">Экспорт JSON</button>
      <input id="importFile" type="file" accept="application/json" style="max-width:320px">
      <button class="btn danger" id="clearAll" type="button">Очистить всё</button>
    </div>
  </section>
</main>

<div id="banner"></div>

<script>
(function(){
  const SKEY='paycalc_v64';
  const APP_VERSION='v6.6';
  const $ = s=>document.querySelector(s);
  const $$ = s=>document.querySelectorAll(s);
  const pad = n => String(n).padStart(2,'0');
  const mkISO = (y,m,d)=>`${y}-${pad(m)}-${pad(d)}`;
  const todayISO = ()=>{const t=new Date();return mkISO(t.getFullYear(),t.getMonth()+1,t.getDate());};
  const isoMonth = d => (d||'').slice(0,7);
  const addMonth = (ym,delta)=>{let[y,m]=ym.split('-').map(Number);m+=delta;while(m<1){m+=12;y--}while(m>12){m-=12;y++}return `${y}-${pad(m)}`};
  const money = n => (Math.round(n)).toLocaleString('ru-RU');
  const banner = (msg)=>{ const b=$('#banner'); b.textContent=msg; b.style.display='block'; clearTimeout(b._t); b._t=setTimeout(()=>b.style.display='none',4000); };

  function safeLoad(){ try{ return JSON.parse(localStorage.getItem(SKEY)) || null; }catch(e){ banner('Хранилище недоступно'); return null; } }
  function safeSave(){ try{ localStorage.setItem(SKEY, JSON.stringify(state)); } catch(e){ console.warn('localStorage недоступен:', e); banner('Данные не сохраняются'); } }

  const persisted = safeLoad();
  const state = persisted || {
    theme:'dark',
    month: new Date().toISOString().slice(0,7),
    settings:{ baseMonthly:0, hoursPerDay:8, weekdayFirstMult:1.5, weekdayNextMult:2, satMult:1.5, sunMult:2, holidayMult:2, vacPayMode:'calendar' },
    holidaysByMonth:{},
    statusesByMonth:{},
    shifts:[],          // [{id,date,type,hours}] — подработки
    leaves:[],          // [{id,date,hours}] — отгулы
    uiSelectedDay:null
  };

  function isWeekdayISO(iso){ const dow=new Date(iso+'T00:00:00').getDay(); return dow>=1 && dow<=5; }
  function isHoliday(dateISO){ const set=new Set(state.holidaysByMonth[isoMonth(dateISO)]||[]); return set.has(dateISO); }
  function isWorkingWeekdayISO(iso){ return isWeekdayISO(iso) && !isHoliday(iso); }

  function computeWorkdays(ym){
    const [y,m]=ym.split('-').map(Number); const days=new Date(y,m,0).getDate();
    let weekdays=0; for(let d=1; d<=days; d++){ const dow=new Date(y,m-1,d).getDay(); if(dow>=1 && dow<=5) weekdays++; }
    const hol=new Set(state.holidaysByMonth[ym]||[]);
    let weekdayHolidays=0; for(const iso of hol){ if(isWeekdayISO(iso)) weekdayHolidays++; }
    return Math.max(0, weekdays - weekdayHolidays);
  }
  function baseHourly(ym){
    const wd=computeWorkdays(ym), hpd=state.settings.hoursPerDay||8, base=state.settings.baseMonthly||0;
    if(base<=0 || wd<=0 || hpd<=0) return 0;
    return base / (wd * hpd);
  }
  function payForShift(shift, hr){
    const h=shift.hours, s=state.settings;
    if(shift.type==='holiday') return h*s.holidayMult*hr;
    if(shift.type==='weekday'){ const first=Math.min(h,2)*s.weekdayFirstMult*hr; const next=Math.max(0,h-2)*s.weekdayNextMult*hr; return first+next; }
    if(shift.type==='saturday') return h*s.satMult*hr;
    if(shift.type==='sunday') return h*s.sunMult*hr;
    return 0;
  }
  function getStatuses(ym){ const s=state.statusesByMonth[ym]||{off:[],vac:[]}; state.statusesByMonth[ym]=s; return s; }
  function lastMonths(ym, n){ let res=[]; let cur=ym; for(let i=0;i<n;i++){ cur = addMonth(cur,-1); res.push(cur); } return res; }

  function countVacationPaidDays(ym){
    const st=getStatuses(ym);
    const vac=(st.vac||[]).slice();
    if(state.settings.vacPayMode==='workdays'){ return vac.filter(isWeekdayISO).length; } else { return vac.length; }
  }

  function monthLeaves(ym){ return state.leaves.filter(l => isoMonth(l.date)===ym); }
  function monthLeavesWorkingHours(ym){
    return monthLeaves(ym).reduce((sum,l)=> sum + (isWorkingWeekdayISO(l.date) ? l.hours : 0), 0);
  }

  function monthlyTotals(ym){
    const hr = baseHourly(ym);
    const rows = state.shifts.filter(s=>isoMonth(s.date)===ym);
    const overtime = rows.reduce((a,s)=>a+payForShift(s,hr),0);
    const otHours = rows.reduce((a,s)=>a+s.hours,0);

    const wd = computeWorkdays(ym);
    const st = getStatuses(ym);
    const offWeekdays = (st.off||[]).filter(isWeekdayISO).length;
    const vacWeekdays = (st.vac||[]).filter(isWeekdayISO).length;

    const base = state.settings.baseMonthly||0;
    const baseHr = baseHourly(ym);

    const unpaidHours = monthLeavesWorkingHours(ym);
    const hpd = state.settings.hoursPerDay||8;
    const unpaidDaysEq = (hpd>0) ? (unpaidHours / hpd) : 0;

    const denom = wd;
    const numer = Math.max(0, wd - offWeekdays - vacWeekdays - unpaidDaysEq);
    const baseEff = denom>0 ? base * (numer / denom) : 0;

    const vacDaysPaid = countVacationPaidDays(ym);
    const avg = averageDaily(ym);
    const vacPay = avg * vacDaysPaid;

    return {baseEff, overtime, vacPay, otHours, vacDaysPaid, unpaidHours, baseHr, sum: baseEff + overtime + vacPay};
  }

  function averageDaily(ym){
    const months = lastMonths(ym, 12);
    let sum = 0;
    const base = state.settings.baseMonthly||0;
    months.forEach(m=>{
      const hasData = (state.shifts.some(s=>isoMonth(s.date)===m) ||
                       (state.statusesByMonth[m] && ((state.statusesByMonth[m].off||[]).length || (state.statusesByMonth[m].vac||[]).length)) ||
                       (state.holidaysByMonth[m] && (state.holidaysByMonth[m].length)) ||
                       (state.leaves && state.leaves.some(l=>isoMonth(l.date)===m)));
      if(hasData){ sum += monthlyTotals(m).sum; } else { sum += base; }
    });
    return sum / (29.3 * 12);
  }

  function autoType(dateISO){
    if(isHoliday(dateISO)) return 'holiday';
    const dow=new Date(dateISO+'T00:00:00').getDay();
    if(dow===0) return 'sunday';
    if(dow===6) return 'saturday';
    return 'weekday';
  }

  const ui = {
    tabs: $$('.tab'), panes: $$('section.card'),
    shiftDate: $('#shiftDate'), todayBtn: $('#todayBtn'), shiftHours: $('#shiftHours'), addShift: $('#addShift'), dayInfo: $('#dayInfo'),
    modeSelect: $('#modeSelect'),
    monthTitle: $('#monthTitle'), prevMonth: $('#prevMonth'), nextMonth: $('#nextMonth'), cal: $('#calendarGrid'),
    dayDetailWrap: $('#dayDetailWrap'), dayRows: $('#dayRows'),
    baseMonthlyOut: $('#baseMonthlyOut'), baseHourlyOut: $('#baseHourlyOut'), overtimeOut: $('#overtimeOut'), otHoursOut: $('#otHoursOut'), grandTotal: $('#grandTotal'), vacInfo: $('#vacInfo'),
    monthFilter: $('#monthFilter'), baseMonthly: $('#baseMonthly'), autoWorkdays: $('#autoWorkdays'), hoursPerDay: $('#hoursPerDay'),
    weekdayFirstMult: $('#weekdayFirstMult'), weekdayNextMult: $('#weekdayNextMult'), satMult: $('#satMult'), sunMult: $('#sunMult'), holidayMult: $('#holidayMult'),
    themeSelect: $('#themeSelect'), updateBtn: $('#updateAppBtn'), updateStatus: $('#updateStatus'),
    holidayGrid: $('#holidayGrid'), monthLabel: $('#monthLabel'),
    exportJSON: $('#exportJSON'), importFile: $('#importFile'), clearAll: $('#clearAll'),
    quickCard: $('#quickCard'),
    appVersion: $('#appVersion')
  };

  ui.tabs.forEach(b=>b.addEventListener('click', ()=>{
    ui.tabs.forEach(x=>x.classList.remove('active')); b.classList.add('active');
    const tab=b.dataset.tab; ui.panes.forEach(p=>p.style.display=(p.dataset.pane===tab?'block':'none'));
    if(tab==='holidays'){ buildHolidayGrid(state.month); }
    if(tab==='journal'){ renderAll(); }
  }));

  document.documentElement.setAttribute('data-theme', state.theme);
  ui.themeSelect.value = state.theme;
  ui.shiftDate.value = todayISO();
  state.uiSelectedDay = state.uiSelectedDay || ui.shiftDate.value;
  ui.monthFilter.value = state.month;
  Object.entries(state.settings).forEach(([k,v])=>{ if(ui[k]) ui[k].value=v; });
  const radios = document.querySelectorAll('input[name="vacPayMode"]');
  radios.forEach(r=>{ r.checked = (r.value === (state.settings.vacPayMode||'calendar')); r.addEventListener('change', e=>{ state.settings.vacPayMode = e.target.value; safeSave(); renderAll(); }); });
  ui.autoWorkdays.value = computeWorkdays(state.month);
  if(ui.appVersion) ui.appVersion.textContent = APP_VERSION;

  function applyModeUI(){
    const mode = ui.modeSelect.value;
    ui.quickCard.style.display = (mode==='overtime') ? 'block' : 'none';
  }
  ui.modeSelect.addEventListener('change', applyModeUI);
  applyModeUI();

  ui.todayBtn.addEventListener('click', ()=>{ ui.shiftDate.value = todayISO(); state.uiSelectedDay=ui.shiftDate.value; renderCalendar(); });
  ui.addShift.addEventListener('click', onAdd);
  ui.shiftHours.addEventListener('keydown', e=>{ if(e.key==='Enter') onAdd(); });

  document.querySelectorAll('[data-quick]').forEach(btn=>btn.addEventListener('click', ()=>{
    if(ui.modeSelect.value!=='overtime') return;
    const code=btn.dataset.quick, date=ui.shiftDate.value||todayISO();
    if(code==='hrs-3.5' || code==='hrs-8'){
      const hours = code==='hrs-3.5' ? 3.5 : 8;
      const type = autoType(date);
      const st=getStatuses(isoMonth(date)); st.off=st.off.filter(x=>x!==date); st.vac=st.vac.filter(x=>x!==date);
      state.shifts.push({id:cryptoRandom(), date, type, hours}); safeSave(); renderAll(); openDay(date); return;
    }
    if(code==='off'){
      const st=getStatuses(isoMonth(date)); const set=new Set(st.off);
      if(set.has(date)){ st.off = st.off.filter(x=>x!==date); } else { set.add(date); st.off = Array.from(set).sort(); st.vac=st.vac.filter(x=>x!==date); }
      state.shifts = state.shifts.filter(s=>s.date!==date);
      safeSave(); renderAll(); openDay(date); return;
    }
    if(code==='vac'){
      const st=getStatuses(isoMonth(date)); const set=new Set(st.vac);
      if(set.has(date)){ st.vac = st.vac.filter(x=>x!==date); } else { set.add(date); st.vac = Array.from(set).sort(); st.off=st.off.filter(x=>x!==date); }
      state.shifts = state.shifts.filter(s=>s.date!==date);
      safeSave(); renderAll(); openDay(date); return;
    }
  }));

  ui.prevMonth.addEventListener('click', ()=>{ state.month=addMonth(state.month,-1); onMonthChanged(); });
  ui.nextMonth.addEventListener('click', ()=>{ state.month=addMonth(state.month, 1); onMonthChanged(); });
  ui.monthFilter.addEventListener('change', e=>{ state.month=e.target.value; onMonthChanged(); });

  ['baseMonthly','hoursPerDay','weekdayFirstMult','weekdayNextMult','satMult','sunMult','holidayMult'].forEach(id=>{
    if(ui[id]) ui[id].addEventListener('change', e=>{ state.settings[id]=parseFloat(e.target.value)||0; safeSave(); renderAll(); });
  });
  ui.themeSelect.addEventListener('change', e=>{ state.theme=e.target.value; document.documentElement.setAttribute('data-theme', state.theme); safeSave(); });

  ui.exportJSON.addEventListener('click', ()=>{
    const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='paycalc_data.json'; a.click();
  });
  ui.importFile.addEventListener('change', async e=>{
    const f=e.target.files[0]; if(!f) return;
    try{
      const data=JSON.parse(await f.text());
      Object.assign(state,{
        theme:data.theme||state.theme,
        month:data.month||state.month,
        settings:Object.assign({},state.settings,data.settings||{}),
        holidaysByMonth:data.holidaysByMonth||{},
        statusesByMonth:data.statusesByMonth||{},
        shifts:Array.isArray(data.shifts)?data.shifts:state.shifts,
        leaves:Array.isArray(data.leaves)?data.leaves:state.leaves
      });
      document.documentElement.setAttribute('data-theme', state.theme);
      ui.themeSelect.value=state.theme;
      ui.monthFilter.value=state.month;
      Object.entries(state.settings).forEach(([k,v])=>{ if(ui[k]) ui[k].value=v; });
      ui.autoWorkdays.value = computeWorkdays(state.month);
      safeSave(); renderAll();
    }catch(err){ alert('Ошибка импорта: '+err.message); }
    ui.importFile.value='';
  });
  ui.clearAll.addEventListener('click', ()=>{ if(confirm('Точно удалить все данные?')){ try{localStorage.removeItem(SKEY)}catch(_){ } location.reload(); } });

  function cryptoRandom(){ try{ return Array.from(crypto.getRandomValues(new Uint8Array(8))).map(b=>b.toString(16).padStart(2,'0')).join(''); }catch(_){ return Math.random().toString(36).slice(2,10); } }

  function onAdd(){
    const date=ui.shiftDate.value||todayISO();
    const hours=parseFloat(ui.shiftHours.value);
    if(!hours||hours<=0){ alert('Укажите часы (>0)'); return; }
    if(ui.modeSelect.value==='overtime'){
      const type=autoType(date);
      const st=getStatuses(isoMonth(date)); st.off=st.off.filter(x=>x!==date); st.vac=st.vac.filter(x=>x!==date);
      state.shifts.push({id:cryptoRandom(), date, type, hours});
    } else {
      state.leaves.push({id:cryptoRandom(), date, hours});
    }
    ui.shiftHours.value=''; safeSave(); renderAll(); openDay(date);
  }

  function onMonthChanged(){
    ui.monthFilter.value = state.month;
    ui.autoWorkdays.value = computeWorkdays(state.month);
    if(isoMonth(state.uiSelectedDay)!==state.month){ const [y,m]=state.month.split('-').map(Number); state.uiSelectedDay = mkISO(y,m,1); ui.shiftDate.value=state.uiSelectedDay; }
    safeSave(); renderAll();
  }

  function renderAll(){
    ui.autoWorkdays.value = computeWorkdays(state.month);
    renderCalendar();
    renderTotals();
    buildHolidayGrid(state.month);
  }

  function renderTotals(){
    const ym=state.month;
    const rows=state.shifts.filter(s=>isoMonth(s.date)===ym);
    const hr=baseHourly(ym);
    const overtime=rows.reduce((a,s)=>a+payForShift(s,hr),0);
    const hours=rows.reduce((a,s)=>a+s.hours,0);

    const totals = monthlyTotals(ym);
    const baseEff = totals.baseEff;
    const vacPay = totals.vacPay;
    const vacDaysPaid = totals.vacDaysPaid;
    const baseHr = totals.baseHr;

    $('#baseMonthlyOut').textContent = (state.settings.baseMonthly||0)>0 ? money(baseEff)+' ₽' : 'не задан';
    $('#baseHourlyOut').textContent = baseHr>0 ? money(baseHr) : '—';
    $('#overtimeOut').textContent = money(overtime)+' ₽';
    $('#otHoursOut').textContent = hours.toFixed(2);
    $('#grandTotal').textContent = money(baseEff + overtime + vacPay)+' ₽';
    const modeText = state.settings.vacPayMode==='workdays' ? 'рабочих' : 'календарных';
    $('#vacInfo').textContent = vacDaysPaid>0 ? `Отпускные: ${vacDaysPaid} ${modeText} дн • ${money(vacPay)} ₽ (среднедневной: ${money(averageDaily(ym))})` : '';
  }

  function renderCalendar(){
    const ym=state.month, [y,m]=ym.split('-').map(Number);
    $('#monthTitle').textContent = new Date(y,m-1,1).toLocaleDateString('ru-RU',{month:'long',year:'numeric'});
    const first=new Date(y,m-1,1), start=(first.getDay()+6)%7, days=new Date(y,m,0).getDate();
    const grid=$('#calendarGrid'); grid.innerHTML='';
    ['Пн','Вт','Ср','Чт','Пт','Сб','Вс'].forEach(h=>{const d=document.createElement('div');d.className='day-head';d.textContent=h;grid.appendChild(d);});
    for(let i=0;i<start;i++) grid.appendChild(document.createElement('div'));
    const today=todayISO();
    const st=getStatuses(ym);
    const offSet=new Set(st.off||[]), vacSet=new Set(st.vac||[]);
    const leavesByDate = new Map();
    state.leaves.filter(l=>isoMonth(l.date)===ym).forEach(l=>{ leavesByDate.set(l.date, (leavesByDate.get(l.date)||0)+l.hours ); });
    for(let d=1; d<=days; d++){
      const iso=mkISO(y,m,d);
      const item=document.createElement('div');
      const dayShifts=state.shifts.filter(s=>s.date===iso);
      const has=dayShifts.length || offSet.has(iso) || vacSet.has(iso) || leavesByDate.has(iso);
      item.className='day'+(has?' has':'')+(iso===today?' today':'')+(state.uiSelectedDay===iso?' selected':'');
      let badge='';
      if(vacSet.has(iso)) badge='🏖️';
      else if(offSet.has(iso)) badge='⏳';
      else if(leavesByDate.has(iso)) badge='⏳';
      else if(dayShifts.length) badge='🔨';
      item.innerHTML=`<div class="num">${d}</div>${has?`<div class="badge">${badge}</div>`:''}`;
      item.addEventListener('click',()=>{ state.uiSelectedDay=iso; ui.shiftDate.value=iso; renderCalendar(); openDay(iso); });
      grid.appendChild(item);
    }
    if(isoMonth(state.uiSelectedDay)===ym){ openDay(state.uiSelectedDay); }
    else { $('#dayDetailWrap').style.display='none'; }
  }

  function openDay(iso){
    const hr = baseHourly(isoMonth(iso));
    const dayShifts = state.shifts.filter(s=>s.date===iso);
    const dayLeaves = state.leaves.filter(l=>l.date===iso);
    showDay(iso, dayShifts, dayLeaves, hr);
    const type=autoType(iso);
    const wday=new Date(iso+'T00:00:00').toLocaleDateString('ru-RU',{weekday:'long'});
    $('#dayInfo').innerHTML = `${iso} — ${wday} • <span class="tag">${type==='weekday'?'Будни (сверхур.)':type==='saturday'?'Суббота':type==='sunday'?'Воскресенье':'Праздник'}</span>`;
  }

  function showDay(iso, dayShifts, dayLeaves, hr){
    const wrap=$('#dayDetailWrap'), tb=$('#dayRows'); wrap.style.display='block'; tb.innerHTML='';
    dayShifts.forEach(s=>{
      const t=s.type==='weekday'?'Будни (сверхур.)':s.type==='saturday'?'Суббота':s.type==='sunday'?'Воскресенье':'Праздник';
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${t} (подработка)</td><td class="right">${s.hours.toFixed(2)} ч</td><td class="right">+${money(payForShift(s,hr))}</td>
        <td class="right"><button class="btn small" data-edit-shift="${s.id}">Ред.</button>
        <button class="btn small danger" data-del-shift="${s.id}">Удал.</button></td>`;
      tb.appendChild(tr);
    });
    const baseHr = baseHourly(isoMonth(iso));
    dayLeaves.forEach(l=>{
      const minus = isWorkingWeekdayISO(iso) ? l.hours*baseHr : 0;
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>Отгул (за свой счёт)</td><td class="right">−${l.hours.toFixed(2)} ч</td><td class="right">−${money(minus)}</td>
        <td class="right"><button class="btn small" data-edit-leave="${l.id}">Ред.</button>
        <button class="btn small danger" data-del-leave="${l.id}">Удал.</button></td>`;
      tb.appendChild(tr);
    });

    tb.onclick=(e)=>{
      const b=e.target.closest('button'); if(!b) return;
      if(b.dataset.editShift){
        const s=state.shifts.find(x=>x.id===b.dataset.editShift); if(!s) return;
        const nh=parseFloat(prompt('Новые часы:', s.hours)); if(!nh||nh<=0) return;
        const nt=prompt('Тип (weekday/saturday/sunday/holiday):', s.type) || s.type;
        s.hours=nh; s.type=nt; safeSave(); renderAll(); openDay(iso);
      }else if(b.dataset.delShift){
        state.shifts=state.shifts.filter(x=>x.id!==b.dataset.delShift); safeSave(); renderAll(); openDay(iso);
      }else if(b.dataset.editLeave){
        const l=state.leaves.find(x=>x.id===b.dataset.editLeave); if(!l) return;
        const nh=parseFloat(prompt('Новые часы отгула:', l.hours)); if(!nh||nh<=0) return;
        l.hours=nh; safeSave(); renderAll(); openDay(iso);
      }else if(b.dataset.delLeave){
        state.leaves=state.leaves.filter(x=>x.id!==b.dataset.delLeave); safeSave(); renderAll(); openDay(iso);
      }
    };
  }

  function buildHolidayGrid(ym){
    const cont=$('#holidayGrid'); cont.innerHTML=''; $('#monthLabel').textContent=ym;
    const [y,m]=ym.split('-').map(Number); const first=new Date(y,m-1,1), start=(first.getDay()+6)%7, days=new Date(y,m,0).getDate();
    const set=new Set(state.holidaysByMonth[ym]||[]);
    const grid=document.createElement('div'); grid.style.display='grid'; grid.style.gridTemplateColumns='repeat(7,1fr)'; grid.style.gap='8px';
    ['Пн','Вт','Ср','Чт','Пт','Сб','Вс'].forEach(h=>{const d=document.createElement('div');d.textContent=h;d.className='muted';grid.appendChild(d);});
    for(let i=0;i<start;i++) grid.appendChild(document.createElement('div'));
    for(let d=1; d<=days; d++){
      const iso=mkISO(y,m,d); const b=document.createElement('button'); b.className='btn small'; b.textContent=d; b.type='button';
      if(set.has(iso)){ b.style.background='#3a1220'; b.style.borderColor='#5c1b2f'; }
      b.onclick=()=>{
        if(set.has(iso)) set.delete(iso); else set.add(iso);
        state.holidaysByMonth[ym]=Array.from(set).sort(); safeSave();
        $('#autoWorkdays').value = computeWorkdays(ym);
        renderAll(); openDay(iso);
      };
      grid.appendChild(b);
    }
    cont.appendChild(grid);
  }

  $('#updateAppBtn').addEventListener('click', async ()=>{
    $('#updateStatus').textContent='Очищаем кэш и обновляем...';
    try{
      if('serviceWorker' in navigator){
        const regs = await navigator.serviceWorker.getRegistrations();
        await Promise.all(regs.map(r=>r.unregister()));
      }
      if('caches' in window){
        const keys = await caches.keys();
        await Promise.all(keys.map(k=>caches.delete(k)));
      }
    }catch(e){ console.warn(e); }
    location.replace(location.pathname + '?v=' + Date.now());
  });

  document.documentElement.setAttribute('data-theme', state.theme);
  renderAll();

  if (location.search.includes('no-sw')) {
    (async ()=>{
      try{
        if('serviceWorker' in navigator){
          const regs = await navigator.serviceWorker.getRegistrations();
          await Promise.all(regs.map(r=>r.unregister()));
        }
        if('caches' in window){
          const keys = await caches.keys();
          await Promise.all(keys.map(k=>caches.delete(k)));
        }
      }catch(_){}
    })();
  }
})();
</script>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js?v=paycalc-v3');
  });
}
</script>
</body>
</html>